---
title: 'Aufgabenblatt 02: Generalisierte lineare Modelle'
author: "Anatol"
date: "3/22/2022"
output: 
  html_document:
    code_folding: hide
    df_print: kable
    fig_caption: yes
    fig_height: 5
    fig_width: 5
    theme: united
    self_contained: yes
    toc: yes
    toc_float: yes
    toc_level: 3
---

```{r, include = FALSE}
library(dplyr)
library(magrittr)
library(flair)
library(pipeR)
library(knitr)
library(rmarkdown)
library(shiny)
library(shinyWidgets)
library(arm)
library(rAmCharts)
library(xfun)
library(car)
library(effects)
library(lmtest)
library(MASS)
library(margins)
colorize <- function(x, color) {
  if (knitr::is_latex_output()) {
    sprintf("\\textcolor{%s}{%s}", color, x)
  } else if (knitr::is_html_output()) {
    sprintf("<span style='color: %s;'>%s</span>", color, 
      x)
  } else x
}

xfun::pkg_load2(c("htmltools", "mime"))
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{css, echo=FALSE}
.description {
  color: gray;
  font-style: italics;
```

# Aufgabe 1: Logit Modelle
```{r}
insur <- read.csv("insurance.csv")
head(insur)
str(insur)
summary(insur)
dim(data)
```
```{r}
any(is.na(insur))
```

```{r}
hist(insur$hhincome)
```
```{r}
hist(log(insur$hhincome + 0.01))
```

## 1a)
*Aufgrund der Rechtsschiefe des Einkommens entscheiden Sie sich fur eine Logarithmierung. Addieren Sie zur Vermeidung von NAs dabei zur Ursprungsvariable zunachst die Konstante 0,001. Dummyvariablen sollten Sie zunachst zu Faktoren umwandeln.*

```{r}
summary(insur$hhincome)
insur$loghhincome <- insur$hhincome + 0.001
summary(insur$loghhincome)
insur$loghhincome <- log(insur$loghhincome)
summary(insur$loghhincome)
```


```{r}
hist(insur$loghhincome)
```
```{r}
insur$ins <- as.factor(insur$ins)
insur$married <- as.factor(insur$married)
insur$retire <- as.factor(insur$retire)
insur$hstatusg <- as.factor(insur$hstatusg)
insur$hisp <- as.factor(insur$hisp)
str(insur)
```
## 1b)
*Passen Sie zunachst einmal das volle Modell an und nutzen Sie dabei den Logit-Link.*
```{r}
plot(ins ~ married, data = insur)
plot(ins ~ retire, data = insur)
plot(ins ~ hstatusg, data = insur)
plot(ins ~ loghhincome, data = insur)
plot(ins ~ hisp, data = insur)
plot(ins ~ age, data = insur)
plot(ins ~ educyear, data = insur)


```


```{r}
logRegFull <- glm(ins ~ married + retire + hstatusg + loghhincome + 
                   age + hisp + educyear, family = binomial(link = "logit"), data = insur)
summary(logRegFull)
```
## 1c)
*Zur Diagnostik schauen Sie sich den binned residual plot an. Dazu verwenden Sie die Funktion binnedplot aus dem arm-Paket und plotten die geﬁtteten Werte auf die Abszisse und die Residuen auf die Ordinate. Wie
interpretieren Sie die Graﬁk? Die Funktion binned.resids mit den bereits zum Plotten genutzten Argumenten
konnte Ihnen hier helfen.*

```{r}
binnedplot(fitted(logRegFull), residuals(logRegFull))
```


```{r}
br <- binned.resids(fitted(logRegFull), residuals(logRegFull))
str(br)
head(br$binned)

mean(abs(br$binned[, "ybar"]) <= br$binned[, "2se"])
```

Die Coverage Rate ist sehr gering. Das spricht fur eine Fehlspezifikation.

## 1d)
*Interpretieren Sie zunachst ganz allgemein die Regressionskoffizienten Ihres Modells. Wie verandert sich c.p. durch eine Heirat die Chance, krankenversichert zu sein? Wie verandert sich c.p. die Chance, wenn eine Person ein weiteres Ausbildungsjahr absolviert hat?*

Die Chance, krankversichert relativ zu nicht krankversichert zu sein, nimmt wenn man verheiratet relativ zu nicht verheiratet ist, und die Absolvierung eines weiteren Ausbildungsjahres zu.

```{r}
exp(coef(logRegFull))
```

## 1e)
*Berechnen Sie den durchschnittlichen marginalen Effekt einer Veranderung der Variable retire.*

```{r}
eff_retire <- fitted(logRegFull)*(1 - fitted(logRegFull))*coef(logRegFull)["retire1"]
ame_retire <- mean(eff_retire)
ame_retire

```
Der durchschnittliche marginale Effekt einer Veranderung der Variable retire ist 0.04723126: Im Durchschnitt erhoht sich die Wahrscheinlichkeit, versichert zu sein um 0.0472, wenn die Person zum Rentner wird.

## 1f)
*Passen Sie ein Modell ohne die Variablen married, retire und hisp an. Berechnen Sie sodann anhand dieses Modells den marginalen Effekt im Mittelwert bezuglich der Variable educyear.*

```{r}
logRegRest <- glm(ins ~ hstatusg + loghhincome + 
                   age + educyear, family = binomial(link = "logit"), data = insur)
summary(logRegRest)

X <- model.matrix(logRegRest)
X_bar <- colMeans(X)
X_bar0 <- X_bar
X_bar0["hstatusg1"] <- 0 
eta_0 <- X_bar0 %*% coef(logRegRest)

prob_0 <- exp(eta_0)/(1 + exp(eta_0))
prob_0
binomial()$linkinv(eta_0)


mem_0 <- prob_0 * (1 - prob_0) * coef(logRegRest)["educyear"]
mem_0

```
```{r}
X_bar1 <- X_bar
X_bar1["hstatusg1"] <- 1 
eta_1 <- X_bar1 %*% coef(logRegRest)

prob_1 <- exp(eta_1)/(1 + exp(eta_1))

mem_1 <- prob_1 * (1 - prob_1) * coef(logRegRest)["educyear"]
mem_1
```

MEM bei einer ungesunden Person: mit einem weiteren Bidlungsjahr steigt die Wahrscheinlichkeit, versichert zu sein um 1,7%.

MEM bei einer gesunden Person: mit einem weiteren Bidlungsjahr steigt die Wahrscheinlichkeit, versichert zu sein um 1,8%.

## 1g)
*Schauen Sie sich die Effektplots fur die Variable educyear im Modell aus Teilaufgabe b) an. Hinweis: Nutzen Sie die Funktion allEffects aus dem effects-Paket.*

```{r}
logit_eff <- allEffects(logRegFull)
names(logit_eff)
plot(logit_eff)
plot(logit_eff[[7]], type = "link")
plot(logit_eff[[7]], type = "response")
```

## 1h)
*Wie hoch ist der Anteil korrekt vorhergesagter Werte im Modell aus Teilaufgabe b)? Als Schwellenwert setzen
Sie 0,5 an.*

```{r}
tab <- prop.table(table(Wahr = insur$ins, Prog = round(fitted(logRegFull))))
tab
sum(diag(tab))
```

Beim Schwellenwert von 0.5 ist der Anteil der korrekt vorhergesagten Werte betragt 63.76%.

## 1i)
*Berechnen Sie fur das Modell aus Teilaufgabe b) das Pseudo-R2.*

```{r}
logRegNull <- glm(ins ~ 1, family = binomial(link = "logit"), data = insur)

PseudoR2 <- 1 - logLik(logRegFull)/logLik(logRegNull)
PseudoR2


1 - logRegFull$deviance/logRegFull$null.deviance
```

Das Pseudo-R2 fur das Modell aus Teilaufgabe b) betragt 0.0936

## 1j)
*Fuhren Sie fur das Modell aus Teilaufgabe b) einen Test auf Fehlspeziﬁkation durch. Hinweis: Nutzen Sie die Funktion lrtest aus dem lmtest-Paket.
*

```{r}
lrtest(logRegNull, logRegFull)
lrtest(logRegFull, . ~ . + I(predict(logRegFull, type = "link")^2))
```
Da das erweiterte Modell mit $\widehat{η^2_i}$ eine signifikant kleinere Signifikanz als das Modell ohne $\widehat{η^2_i}$, ist das Modell inkorrekt spezifiziert. Wie konnen davon ausgehen, dass quadrierter linearer Pradiktor einen signifikanten Erklarungsgehalt hatte.


## 1k)
*Fuhren Sie eine Variablenselektion mit der schrittweisen Selektion durch. Gehen Sie vom Modell aus Teilaufgabe b) aus und geben Sie dieses Modell mit samtlichen Interaktionstermen zweiter Ordnung als Maximalmodellan (uber Nutzung von ^2 in Formel). Nutzen Sie dabei das Paket MASS.*
```{r}
step_mod <- stepAIC(logRegFull, scope = list(upper = ~ .^2), direction = "both")
summary(step_mod)
```
# Aufgabe 2: Probit Modelle

## 2a)
*Passen Sie das gleiche Modell wie in Aufgabe 1 b) an, verwenden Sie diesmal jedoch die Probit-Linkfunktion.*

```{r}
probRegFull <- glm(ins ~ married + retire + hstatusg + loghhincome + 
                   age + hisp + educyear, family = binomial(link = "probit"), data = insur)
summary(probRegFull)
```
## 2b)
*Vergleichen Sie die geschatzten Wahrscheinlichkeiten aus dem Logit- und Probit-Modell.*
```{r}
head(fitted(logRegFull))
head(fitted(probRegFull))
summary(fitted(logRegFull) - fitted(probRegFull))

```

```{r}
plot(fitted(logRegFull), fitted(probRegFull))
abline(0,1)
```
```{r}
head(fitted(probRegFull))
head(pnorm(model.matrix(probRegFull) %*% coef(probRegFull)))
```

 
## 2c)
*Was konnen Sie uber die $\widehat{β_s}$ der beiden Modelle sagen?*
```{r}
beta_log <- summary(logRegFull)$coef[, 1]
beta_log

beta_pro <- summary(probRegFull)$coef[, 1]
beta_pro

mean(beta_log/beta_pro)
```

Die $\widehat{β_s}$ der beiden Modelle unterscheiden sich, haben jedoch die gleichen Vorzeichen.



## 2d)
*Berechnen Sie den Anteil korrekt vorhergesagter Werte fur das Probit-Modell.*
```{r}
tab_prob <- prop.table(table(Obs = insur$ins, Pred = round(fitted(probRegFull))))
tab_prob
sum(diag(tab_prob))
```

Der Anteil korrekt vorhergesagter Werte fur das Probit-Modell betragt
63.88%.

## 2e)
*Berechnen Sie den durchschnittlichen marginalen Effekt einer Veranderung der Variable retire im Probit-Modell und vergleichen Sie das Ergebnis mit Aufgabe 1 e). Beachten Sie, dass Sie fur diese Berechnung nichteinfach auf die entsprechende Formel des Logit-Modells zuruckgreifen konnen.*

```{r}
eta <- model.matrix(probRegFull) %*% coef(probRegFull)
eta_prob <- dnorm(eta) * coef(probRegFull)["retire1"]
ama_prob <- mean(eta_prob)
ama_prob
```




